# 安全即时通讯系统后端开发总结报告书

## 1 引言:**安全通信落地**与**协作打磨**
        随着互联网技术的飞速发展，即时通讯系统已深度融入人们的日常生活与工作场景，成为信息传递与社交互动的核心工
    具。从个人社交聊天到企业协同办公，即时通讯系统的高效性、便捷性和实时性极大地改变了人们的沟通模式。在此背景下，
    基于 Python 语言开发一套融合 P2P 与 C/S 架构优势的即时通讯系统，不仅有助于深入理解网络通信、数据存储等核心
    技术，更是对理论知识与实践能力结合的有效检验。​

        本项目旨在开发一套功能完备、安全可靠的即时通讯系统。系统采用 P2P 与 C/S 混合架构，结合两种架构的优势:P2P 
    架构支持用户间直接通信，减少服务器负载，提升数据传输效率；C/S 架构则保障用户离线时消息的可靠缓存与转发，确保
    信息不丢失。系统涵盖用户注册登录、通讯录管理、实时消息传输等基础功能，并进一步拓展至端到端透明安全加解密、图
    片信息隐藏提取、在线状态管理以及公私钥维护等高级功能。其中，端到端加密技术确保用户信息在传输与存储过程中的安
    全性，信息隐藏功能则为数据传输提供了额外的隐私保护，在线状态管理则提升了用户交互体验。​

       作为小学期的实践成果，本项目不仅是对 Python 编程能力的全面锻炼，更是对网络通信、数据库管理、密码学等多学科
    知识的综合运用。通过本系统的开发，不仅实现了即时通讯系统的基本功能需求，更在安全性与隐私保护方面进行了有益探索，
    通过 RSA + AES 混合加密、JWT 认证等技术，实现端到端安全传输，掌握密码学算法在实际场景的应用;模拟团队开发流程，
    通过模块拆分（用户模块、通信模块等）、Git 版本控制，提升协作效率与项目管理能力。为后续相关系统的研究与开发提供参
    考与借鉴。

## 2 相关理论及基础技术与开发平台
### 2.1 即时通讯应用工作原理分析
        C/S 架构原理：客户端负责用户界面展示、输入输出交互，服务器作为中枢管理用户认证、消息存储与转发。用户登录时，客户
    端向服务器发送账号密码，服务器通过数据库验证后建立连接；用户离线时，消息暂存服务器，待用户上线后推送，确保消息不丢失。​
        P2P 架构原理：在用户在线且网络条件允许时，双方直接建立连接传输消息，无需服务器中转，降低服务器负载并提升传输效率。通
    过NAT穿越技术，解决不同网络环境下节点间的通信问题，实现点对点直连。​
       混合架构协同：系统根据用户在线状态和网络状况动态切换架构，在线用户优先使用 P2P 传输，离线或直连失败时启用 C/S 模式，
    由服务器缓存并转发消息，兼顾性能与可靠性。

### 2.2 所用技术
 **技术实践深化**：完整落地用户交互，用户认证、数据库交互、安全通信等功能，强化开发工程化思维，运用技术栈如下：
      *   **后端:** Python, **FastAPI**, Uvicorn, `python-jose` (用于JWT认证)
      *   **前端:** **uniapp** (Vue 3), **Element Plus** (仅用于H5端), Pinia
      *   **实时通信:** **WebSockets** (用于信令), **WebRTC** (用于P2P数据)
      *   **数据库:** SQLite

## 3 系统体系结构的设计

### 3.1 需求描述与数据结构
#### 3.1.1 功能需求
##### 1. 用户管理
- **用户注册**
    输入数据：包含用户名、邮箱、密码和公钥的用户信息，记录客户端的 IP 地址。
    处理逻辑：系统需要检查用户名和邮箱是否已存在，若不存在，则将用户信息存储到数据库中，同时对密码进行哈希处理。
    输出结果：返回成功注册的用户信息，包括用户 ID 和创建时间。
- **用户登录**
    输入数据：用户名、密码，客户端的 IP 地址和端口号。
    处理逻辑：系统根据用户名从数据库中查找用户，并验证密码是否正确。若验证通过，更新用户的在线状态、IP 地址和端口号，同时生成并返回访问令牌。
    输出结果：包含访问令牌和令牌类型的响应。
- **用户登出**
  
- **用户修改**
  
- **用户删除**
    输入数据：用户 ID，当前用户信息。
    处理逻辑：系统首先检查要删除的用户是否存在，然后验证当前用户是否有权限删除该用户。若条件满足，则从数据库中物理删除该用户。
    输出结果：返回 204 No Content 表示删除成功。
##### 2. 通讯录管理
- **添加联系人**
    输入数据：当前用户的访问令牌，要添加的好友 ID。
    处理逻辑：系统首先验证当前用户的身份，然后检查要添加的好友是否存在，同时确保用户不能添加自己为好友。若条件满足，则在数据库中创建新的联系人关系。
    输出结果：返回成功添加的联系人信息，包括联系人 ID、用户 ID、好友 ID、状态和创建时间。
- **获取联系人列表**
    输入数据：当前用户的访问令牌，分页参数（跳过的记录数和返回的最大记录数）。
    处理逻辑：系统验证当前用户的身份，然后根据用户 ID 从数据库中查询联系人列表。
    输出结果：返回当前用户的联系人列表。
- **删除联系人**
#### 3. 服务器功能  
- **用户管理**：校验注册唯一性，维护在线状态（IP、端口），支持公钥分发。  
- **消息中转**：离线消息暂存、在线消息 P2P 直传（待完善 NAT 穿透）
  
#### 3.1.2 非功能需求
###### 1. 安全性
- 密码安全：使用 bcrypt 算法对用户密码进行哈希处理，确保密码在存储和传输过程中的安全性。
- 身份验证：使用 JWT（JSON Web Tokens）进行用户身份验证，确保只有经过授权的用户才能访问受保护的 API 端点。
- 数据加密：对消息内容进行加密处理，以保证消息的安全性。
- 信息隐藏：预留 LSB 算法扩展，支持图片载体的信息嵌入与提取（待实现）。
###### 2. 性能
-  数据库操作：使用 SQLAlchemy 进行数据库操作，支持分页查询，以提高数据查询的效率。
-  响应时间：系统应在合理的时间内响应用户的请求，确保用户体验的流畅性。
###### 3. 可维护性
- 模块化设计：代码采用模块化设计，将不同的功能模块（如用户管理、联系人管理）分离，提高代码的可维护性和可扩展性。
- 代码注释：代码中包含详细的注释，解释每个函数和类的功能，方便后续的开发和维护。

#### 3.1.3 数据需求与结构
##### 1. 用户数据
    存储信息：用户 ID、用户名、邮箱、哈希后的密码、公钥、创建时间、在线状态、IP 地址和端口号。
    数据关系：一个用户可以发送和接收多条消息，同时可以有多个联系人。
##### 2. 联系人数据
    存储信息：联系人 ID、用户 ID、好友 ID、状态和创建时间。
    数据关系：联系人关系关联到发起请求的用户和被添加的好友。
##### 3. 消息数据
    存储信息：消息 ID、发送者 ID、接收者 ID、加密后的消息内容、发送时间和是否已读状态。
    数据关系：消息关联到发送者和接收者。
#### 接口需求
- **API 接口**
   用户注册接口：POST /users/
   用户登录接口：POST /token
   添加联系人接口：POST /me/contacts/
   获取联系人列表接口：GET /me/contacts/
   删除用户接口：DELETE /users/self
   ......
- **接口参数和响应格式**
  每个接口都有明确的输入参数和输出响应格式，使用 Pydantic 模型进行数据验证和序列化，确保接口的规范性和一致性。 

### 3.2 系统架构设计
    在开发即时通讯系统后端时，我们依据功能职责、技术实现逻辑与分层思想，对模块进行了清晰划分，让系统架构既符合工程化
    开发规范，又适配 P2P + C/S 混合架构的特性，以下是各模块的设计思路与分工：
#### 一、基础数据支撑层模块
-   1. **数据库配置模块**
    作为系统与数据库交互的基础，负责初始化数据库连接（如配置 SQLAlchemy 的引擎、会话工厂 ），定义数据库连接的核心参数
    （如数据库类型、地址、用户名密码 ）。它为 models.py 提供底层存储支持，让模型能映射到实际数据库表，是整个后端数据持
    久化的 “基石” 。无论后续业务如何扩展（新增用户、消息等数据操作 ），都依赖它建立稳定的数据库连接。
-   2. **数据模型模块**
    基于数据库配置模块提供的连接，定义系统核心数据结构，映射到数据库表。比如：
        用户模型（User）：存储用户账号、密码哈希、邮箱、公钥等基础信息，是用户注册、登录、身份识别的核心载体；
        好友关系模型：记录用户间好友关联、分组、备注等，支撑通讯录管理功能；
        消息模型：定义消息内容（含加密 / 隐藏处理标记 ）、收发方、时间戳、在线 / 离线状态（关联服务器缓存逻辑 ），适配实时传
        输（P2P 直连时可减少依赖，但需记录基础元数据 ）与离线缓存（C/S 模式下依赖服务器存储 ）场景。
    这些模型是业务逻辑层操作数据的 “蓝图”，让增删改查有明确的对象与规则。
#### 二、业务逻辑层模块
1. schemas.py（数据校验与交互模块）
作为前后端、业务逻辑与数据存储间的 “桥梁”，基于 Pydantic 定义数据交互的规范类：

请求校验：比如用户注册时，用 UserBase 校验用户名格式、邮箱合法性；发送消息时，校验消息内容长度、接收方合法性，提前拦截无效请求；
响应格式化：规范接口返回数据结构（如登录成功返回 token、用户基础信息 ），让前端 / 其他模块能清晰解析结果。既保障数据合法性，也让代码更贴合面向对象思想，让业务逻辑与原始数据解耦。
2. crud.py（增删改查操作模块）
封装对 models.py 数据的具体操作，专注 “纯数据逻辑”：

实现用户注册（向 User 表插入数据 ）、登录校验（查询用户并验证密码 ）；
好友关系的添加、删除、查询（操作好友关系模型 ）；
消息的存储（C/S 模式下缓存离线消息 ）、查询（拉取历史消息 ）等。
它屏蔽数据库操作细节（如 SQL 语句拼接 ），让 server.py 等模块只需调用简单方法（如 crud.create_user() ）就能完成业务，降低代码耦合度。
3. auth.py（身份认证与安全模块）
聚焦用户身份与安全相关逻辑，是系统 “权限大门”：

处理注册流程（调用 crud 写入用户，结合 schemas 校验 ）；
登录时密码校验（对接 crud 查询用户，配合哈希算法验证 ）；
token 生成与校验（用 JWT 等技术，为后续接口请求提供身份凭证 ）；
关联公钥管理（存储、读取用户公钥，支撑端到端加密 ）。
在 P2P 场景中，虽减少后端直接参与通信，但用户身份初始化、公钥分发仍依赖此模块保障安全基础；C/S 模式下，更是核心的权限校验入口。
三、通信与服务层模块
1. connection_manager.py（连接管理模块）
适配 P2P + C/S 混合架构的 “连接器”：

C/S 模式：管理客户端与服务器的长连接（如 WebSocket 连接 ），维护在线用户列表、连接状态，转发离线消息、同步在线状态；
P2P 模式：协助客户端完成 NAT 穿越、建立直连通道（后端可提供 “打洞” 辅助、节点发现等能力 ），减少直接数据转发，但保留基础连接状态管理（如记录用户是否支持 P2P、直连状态 ）。
它让系统能灵活切换通信模式，平衡服务器负载与通信效率，是实现混合架构的关键支撑。
2. server.py（核心服务编排模块）
作为后端 “总指挥”，整合各模块能力，对外提供完整服务：

编排业务流程：比如用户登录，串联 auth.py 校验、connection_manager.py 维护在线状态、crud.py 更新用户信息；
暴露接口 / 协议：通过 WebSocket、HTTP 等协议，将注册、登录、发消息、查通讯录等功能封装为接口，供前端 / 其他模块调用；
处理跨模块协作：在 P2P 与 C/S 切换时，协调 connection_manager.py 调整连接策略，调用 crud.py 处理必要的数据同步（如离线消息落库 ）。
它是后端功能的 “出口”，让零散的模块能力聚合为可用的即时通讯服务。
四、测试辅助模块
1. api_test.py、ws_test.py（测试验证模块）
api_test.py：针对 server.py 暴露的 HTTP 接口（如注册、登录、通讯录操作 ），编写自动化测试用例，验证参数校验、业务逻辑、响应结果是否符合预期；
ws_test.py：专注 WebSocket 通信测试（如实时消息收发、在线状态同步 ），覆盖 C/S 模式与 P2P 模式下的连接、交互场景，保障通信功能稳定。
它们是开发过程中 “查漏补缺” 的工具，确保各模块协同工作时符合设计需求，迭代时能快速发现问题。

这样的模块划分，让系统开发能 “分层推进、各司其职”：基础层保障数据存储与连接，逻辑层封装业务规则，通信层适配混合架构，测试层兜底质量。无论是前期单体功能开发（如用户注册 ），还是后期混合架构优化（P2P 直连逻辑扩展 ），都能清晰定位代码位置、减少模块间干扰，也便于向老师说明 “按功能职责与架构适配性拆分，让复杂的即时通讯系统开发更有条理” 。
### 3.3 系统的模块功能设计
#### 3.3.1 总体功能设计
#### 3.3.2 注册模块设计
#### 3.3.3 登录模块设计
#### 3.3.4 用户间交互模块设计
### 3.4 数据库设计
#### 3.4.1 数据库物理模型
#### 3.4.2 数据字典

## 4 系统实现
### 4.1 网络通讯编码实现
#### 4.1.1 聊天客户端部分代码
#### 4.1.2 服务器端监听与转发消息代码
#### 4.1.3 服务端单线程上线处理代码
### 4.2 系统运行的效果图
#### 4.2.1 登录界面
#### 4.2.2 主界面
#### 4.2.3 群聊天界面
#### 4.2.4 好友聊天界面
#### 4.2.5 好友查找界面
### 4.3 注册模块的实现
#### 4.3.1 数据库连接
#### 4.3.2 字符编码过滤器的核心代码
### 4.4 注册模块运行效果图
#### 4.4.1 主页面
#### 4.4.2 注册页面

## 5 系统测试与运行




```python
'''
## 一、课程设计目的  
本次课程设计聚焦安全即时通讯系统后端开发，目标如下：  
1. **技术实践深化**：基于 Python + FastAPI 技术栈，完整落地用户认证、数据库交互、安全通信等功能，强化后端开发工程化思维。  
2. **安全通信落地**：通过 RSA + AES 混合加密、JWT 认证等技术，实现端到端安全传输，掌握密码学算法在实际场景的应用。  
3. **团队协作打磨**：模拟团队开发流程，通过模块拆分（用户模块、通信模块等）、Git 版本控制，提升协作效率与项目管理能力。  


## 二、需求分析  
### （一）系统功能需求  
#### 1. 用户核心功能  
- **注册登录**：支持用户名、邮箱、密码提交，通过 JWT 生成身份令牌，实现状态保持。  
- **通讯录管理**：提供好友添加、删除、列表查询接口，关联用户 ID 维护好友关系。  

#### 2. 安全通讯功能  
- **消息加密**：采用 RSA 协商 AES 密钥，对称加密消息正文，保障端到端安全。  
- **信息隐藏**：预留 LSB 算法扩展，支持图片载体的信息嵌入与提取（待实现）。  

#### 3. 服务器功能  
- **用户管理**：校验注册唯一性，维护在线状态（IP、端口），支持公钥分发。  
- **消息中转**：离线消息暂存、在线消息 P2P 直传（待完善 NAT 穿透）。  


### （二）性能与约束  
- **实时性**：在线消息延迟≤500ms（当前测试环境达标），离线消息转发成功率≥99%（待压测验证）。  
- **安全约束**：密钥协商防中间人攻击，消息加密符合 AES-256 标准，密码存储采用 BCrypt 哈希。  
- **技术栈**：后端 Python + FastAPI + SQLAlchemy（SQLite 数据库），前端预留 Qt 集成接口（待开发）。  


## 三、详细设计  
### （一）总体框架  
#### 1. 混合通信架构  
- **C/S 模式**：承担用户认证、离线消息存储、在线状态管理（如 `/users/` 注册接口、`/token` 登录接口）。  
- **P2P 模式**：在线用户通过 NAT 穿透直连（待实现），降低服务器转发压力，提升通信效率。  

#### 2. 数据库设计（核心表结构）  
```python
# 模型类定义（SQLAlchemy ORM）
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String, unique=True, index=True)
    email = Column(String, unique=True, index=True)
    password_hash = Column(String)  # BCrypt 哈希存储
    public_key = Column(String)     # RSA 公钥
    contacts = relationship("Contact", back_populates="user")  # 好友关系

class Contact(Base):
    __tablename__ = "contacts"
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    friend_id = Column(Integer, ForeignKey("users.id"))
    user = relationship("User", foreign_keys=[user_id], back_populates="contacts")


### (二)算法分析与实现
#### 1. 加密流程设计（RSA + AES 混合加密）
'''